{% extends "base.html" %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4>Natural Language to SQL Query</h4>
      <a href="/" class="btn btn-outline-secondary">Change Database</a>
    </div>

    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <div class="card">
      <div class="card-body">
        <form method="POST">
          <div class="mb-3">
            <label for="query" class="form-label">Enter your question in natural language:</label>
            <textarea
              class="form-control query-box"
              id="query"
              name="query"
              placeholder="e.g., Show me all active users who signed up in the last 30 days"
              required
            ></textarea>
          </div>
          <button type="submit" class="btn btn-success">Generate & Execute SQL</button>
          <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#logicModal">
            Application Logic
          </button>
        </form>
      </div>
    </div>

    <div class="mt-4">
      <div class="alert alert-info">
        <h6>Tips for better results:</h6>
        <ul class="mb-0">
          <li>Be specific about the data you want to retrieve</li>
          <li>Mention table names and column names if you know them</li>
          <li>Specify any filters or conditions (date ranges, status, etc.)</li>
          <li>Use natural language - "show me", "find all", "list", etc.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Application Logic Modal -->
<div class="modal fade" id="logicModal" tabindex="-1" aria-labelledby="logicModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logicModalLabel">Application Logic</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label for="logicText" class="form-label">Describe your application rules or domain logic:</label>
        <textarea
          id="logicText"
          class="form-control"
          rows="8"
          placeholder="Example: In 'project' table, type 'P' means Project and type 'R' means Recipe..."
        ></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" id="saveLogicBtn" class="btn btn-primary">Save Logic</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById("saveLogicBtn").addEventListener("click", async () => {
    const logicText = document.getElementById("logicText").value.trim();
    if (!logicText) {
      alert("Please enter some application logic before saving.");
      return;
    }

    const response = await fetch("/api/save-logic", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ logic: logicText }),
    });

    const result = await response.json();
    if (result.status === "success") {
      alert("Application logic saved successfully!");
      document.getElementById("logicText").value = "";
      const modal = bootstrap.Modal.getInstance(document.getElementById("logicModal"));
      modal.hide();
    } else {
      alert("Failed to save logic: " + result.error);
    }
  });
</script>

<script>
  document.getElementById('logicModal').addEventListener('show.bs.modal', async () => {
    const response = await fetch('/api/get-logic');
    const data = await response.json();
    document.getElementById('logicText').value = data.logic || '';
  });
</script>

{% endblock %}